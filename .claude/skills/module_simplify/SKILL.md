# Simplify Skill

## 触发方式

用户输入 `/simplify <功能名>` 时触发此技能。

参数 `<功能名>` 是目标功能模块的自然语言描述，例如：
- `避障` — NMPC 局部避障
- `姿态控制` — 姿态 PID 控制器
- `路径规划` — A* / 多段路径规划
- `位置控制` — 位置控制器
- `状态估计` — 卡尔曼滤波器
- `任务管理` — 航线任务状态机

## 描述

分析指定模块的代码，在保证飞行速度、姿态、稳定性、避障能力等不退化的前提下，识别并移除非必要逻辑，降低复杂度，提高可读性。

## 阶段一：分析（只读，不改代码）

### 1. 定位并读取目标文件

根据功能名在 `Source/uav_simulator/` 下搜索相关源码：
- 用 Glob 按文件名模糊匹配，用 Grep 按类名/关键词定位
- 读取匹配到的所有 .h 和 .cpp，建立完整理解
- 列出本次分析的文件清单（含行数），供用户确认范围是否正确

### 2. 交叉引用扫描

对目标文件中的每个 public/protected 函数、结构体字段、配置项，在整个项目中搜索调用点：
- `Grep` 搜索函数名/字段名
- 记录每个符号的外部消费者数量

### 3. 运行仿真采集基线日志

- Windows: `cmd //c "Script\\sim.bat 120"`
- macOS/Linux: `bash Script/sim.sh 120`
- 读取 `Logs/uav.log`，记录关键指标作为基线：
  - 巡航速度范围
  - Stuck 触发次数和类型
  - NeedsCorrection 状态变化次数
  - 跟踪误差（实际轨迹与期望轨迹的偏差，应 ≤ 2m）
  - 航线是否完成

### 4. 逐项评估可移除性

对每个候选项，按以下分类判定：

**可移除：**

| 类别 | 判定标准 | 动作 |
|------|---------|------|
| 内部死代码 | private 函数/变量，内部计算结果无人消费，且不属于公共接口 | 移除 |
| 被覆盖的逻辑 | 计算结果总是被下游覆盖，实际是死代码 | 移除 |
| 从未触发的检测器 | 基线日志中从未出现，且触发条件是其他检测器的严格子集 | 移除 |
| 废弃且已被替代的内部字段 | 有新机制完全替代，字段从未被读取（仅被写入） | 移除 |
| 收益不明确的优化循环 | 额外迭代/精炼步骤，代码量大但效果无法从日志中观测到 | 移除 |
| 注释掉的代码 | 可能是临时注释或调试用途，不视为死代码 | 保留 |

**不可移除：**

| 类别 | 判定标准 | 动作 |
|------|---------|------|
| 公共接口 | public/protected 的 getter、setter、BlueprintCallable 函数，即使当前无 C++ 调用点。这些是模块对外暴露的职责边界，可能被蓝图或后续扩展使用 | 保留 |
| 有活跃消费者的逻辑 | 被外部模块、可视化、测试依赖 | 保留 |
| 日志中活跃触发的检测器 | 基线日志中实际触发过 | 保留 |
| 配置项 (UPROPERTY) | 可通过编辑器/蓝图调整的参数，除非能证明其关联逻辑已被完全移除 | 保留 |

### 5. 输出简化计划

以结构化格式输出计划，包含：
- 每个简化项的原因、涉及的文件和行号、具体移除/修改内容
- 明确列出"不动的部分"及保留理由
- 预估行数变化
- 需要适配的测试

**在此处暂停，等待用户确认后再进入阶段二。**

## 阶段二：实施

### 6. 逐项执行代码修改

按计划逐项修改，每项修改后立即检查括号匹配和语法完整性。

### 7. 适配测试

- 移除依赖已删除功能的测试用例
- 确保剩余测试的断言不引用已移除的字段/配置项

### 8. 编译验证

- Windows: `cmd //c "Script\\build.bat"`
- macOS/Linux: `bash Script/build.sh`
- 编译失败 → 读取错误 → 修复 → 重新编译

### 9. 单元测试

- Windows: `cmd //c "Script\\test.bat"`
- macOS/Linux: `bash Script/test.sh`
- 对比改动前后的通过率，确认无新增失败

### 10. 仿真回归验证

- Windows: `cmd //c "Script\\sim.bat 120"`
- macOS/Linux: `bash Script/sim.sh 120`
- 读取 `Logs/uav.log`，与阶段一基线对比：
  - 巡航速度无显著下降
  - Stuck 检测仍正常工作
  - 避障行为无退化
  - 轨迹跟踪误差无显著增大（仍 ≤ 2m）
  - 航线正常完成
- 发现退化 → 回滚相关改动 → 重新编译验证

### 11. 输出总结

简要说明移除了什么、减少了多少行、验证结果。

## 约束

- 阶段一（分析）完成后必须暂停等待用户确认，不得直接进入实施
- 不要主动提交代码
- 不要移除公共接口：public/protected 的 getter、setter、BlueprintCallable 函数是模块的职责边界，即使当前无调用点也必须保留
- 不要移除有活跃外部消费者的逻辑
- 不要移除日志中实际触发过的检测器
- 只移除真正的死代码：内部计算结果无人消费、被下游完全覆盖、从未触发且为其他检测器严格子集的逻辑
- 对拿不准的项，宁可保留也不要冒险移除
